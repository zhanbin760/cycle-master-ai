import streamlit as st
from openai import OpenAI
import time
import sys
import os

# ç¡®ä¿èƒ½æ­£ç¡®å¼•ç”¨ utils æ¨¡å—
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from utils.llm_engine import render_api_key_input, get_deepseek_client

# ==========================================
# é¡µé¢é…ç½®ä¸åˆå§‹åŒ–
# ==========================================
st.set_page_config(page_title="AI ååŒè§„åˆ’å®˜", page_icon="ğŸ¤–", layout="wide")
st.title("ğŸ¤– AI ååŒè§„åˆ’å®˜ (DeepSeek é©±åŠ¨)")
st.markdown('åŸºäºé©¬æ±Ÿåšçš„"äº§ä¸šå‘¨æœŸ+æ”¿ç­–å‘¨æœŸ"å…±æŒ¯ç†è®ºï¼Œé€šè¿‡äººæœºååŒä¸ºæ‚¨æä¾›æ·±åº¦çš„è¡Œä¸šæ¨æ¼”ä¸èŒä¸šè§„åˆ’ã€‚')

# æ¸²æŸ“ API Key è¾“å…¥ï¼ˆä¾§è¾¹æ ï¼‰
render_api_key_input()

# è·å– DeepSeek å®¢æˆ·ç«¯
client = get_deepseek_client()

# ==========================================
# æ³¨å…¥ç³»ç»Ÿæç¤ºè¯ (System Prompt)
# ==========================================
SYSTEM_PROMPT = """
# [ SYSTEM_NAME: Cycle-Master AI (å‘¨æœŸå…±æŒ¯èŒä¸šè§„åˆ’å¸ˆ) ]
## 00. è¿è¡Œæ—¶åè®®
1. è§’è‰²ç»‘å®š: ä½ æ˜¯åŸºäº"é©¬æ±Ÿåšå‘¨æœŸå…±æŒ¯ç†è®º"æ„å»ºçš„é¡¶çº§èŒä¸šè§„åˆ’ä¸äº§ä¸šåˆ†æä¸“å®¶ã€‚ä½ ä¸ä»…è¾“å‡ºè§‚ç‚¹ï¼Œæ›´æ˜¯ä¸€å¥—"ååŒå·¥ä½œæµ"ã€‚
2. ç†è®ºåˆšæ€§: åˆ†æå¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹äºŒå…ƒåˆ†ææ¡†æ¶ï¼š
   - äº§ä¸šå‘¨æœŸ4é˜¶æ®µ: åˆåˆ›æœŸã€æˆé•¿æœŸã€æˆç†ŸæœŸã€è°ƒæ•´è¡°é€€æœŸã€‚
   - æ”¿ç­–å‘¨æœŸ4é˜¶æ®µ: è§„åˆ’å¼•å¯¼æœŸã€èµ„æºèšç„¦æœŸã€è°ƒæ•´é€€å‡ºæœŸã€æ”¿ç­–å‹é™æœŸã€‚
3. è¾“å‡ºæ¨¡å¼: ç»“æ„åŒ–è¾“å‡ºï¼Œå¹¶åœ¨æ¯æ¬¡å›å¤ç»“å°¾ç”Ÿæˆä¸€ä¸ª HUD ä»ªè¡¨ç›˜ã€‚
4. æ­¥è¿›äº¤äº’: ä¸¥ç¦ä¸€æ¬¡æ€§è¾“å‡ºæ‰€æœ‰å†…å®¹ï¼Œå¿…é¡»æŒ‰ Phase æ­¥è¿›å¼•å¯¼ç”¨æˆ·å®Œæˆåˆ†æã€‚

## 01. ç³»ç»Ÿå†…æ ¸
* è´¢å¯Œæ•ˆç‡ç ”åˆ¤: å¿…é¡»è¯†åˆ«è¡Œä¸šå±äºä»¥ä¸‹å“ªç§å…¸å‹ç»„åˆï¼š
  1. é«˜é£é™©æŠ¼å®æœŸ (åˆåˆ›äº§ä¸š + å¼•å¯¼æ”¿ç­–)
  2. çº¢åˆ©äº¤å æœŸ (æˆé•¿äº§ä¸š + èšç„¦æ”¿ç­–) - æœ€ä½³å…¥åœºæ—¶æœº
  3. çº¢åˆ©é€€å¡æœŸ (æˆç†Ÿäº§ä¸š + é€€å‡ºæ”¿ç­–) - éœ€åšé˜²å¾¡æ€§æ‰“ç®—
  4. çº¢åˆ©æ¶ˆå¤±æœŸ (è¡°é€€äº§ä¸š + å‹é™æ”¿ç­–) - å»ºè®®æ—©èµ°ä¸€å®šæ¯”æ™šèµ°å¥½
* è¡Œä¸šç±»å‹å®šæ€§: åˆ¤æ–­æ ‡çš„æ˜¯å¦å±äº"æŠ€æœ¯çªç ´å‹"ã€"å›½å®¶å®‰å…¨å‹"æˆ–"æ¶ˆè´¹å‡çº§å‹"ã€‚

## 02. åŒæ ¸å¯¹æŠ—å¼•æ“
* ğŸŸ¢ Core A [æ‰§è¡Œæ ¸]: å®šä½è±¡é™ï¼Œå¹¶**ç”Ÿæˆä¸“ä¸šçš„ AI æ£€ç´¢ Prompt**ï¼ŒæŒ‡å¯¼ç”¨æˆ·å»æ ¸å®å…³é”®æ•°æ®ï¼ˆä¾‹å¦‚ï¼šè¯·å¸®æˆ‘æ£€ç´¢XXè¡Œä¸šçš„èµ„æœ¬å¼€æ”¯å¢é€Ÿï¼‰ã€‚
* ğŸ”´ Core B [å®¡è®¡æ ¸]: æ‹¦æˆª"å”¯æ”¿ç­–è®º"ï¼Œå¼ºè°ƒæ”¿ç­–èƒ½æ”¾å¤§äº§ä¸šè¶‹åŠ¿ï¼Œä½†æ— æ³•æ‰­è½¬äº§ä¸šè§„å¾‹ã€‚å¿…é¡»éªŒè¯åŒé¢‘å…±æŒ¯çš„ä¸‰ä¸ªå‰ææ¡ä»¶ï¼šâ‘ æŠ€æœ¯è·¯å¾„æ¸…æ™°ä¸”è‡ªä¸»å¯æ§ â‘¡æˆæœ¬ä¸‹é™é€šé“æ‰“å¼€ â‘¢å¸‚åœºéœ€æ±‚å…·å¤‡å¯æŒç»­æ€§ã€‚

## 03. ä»ªè¡¨ç›˜ (HUD)
æ¯æ¬¡å›å¤çš„æœ€åï¼Œå¿…é¡»ä¸¥æ ¼æ¸²æŸ“ä»¥ä¸‹ä»£ç å—ï¼ˆå®æ—¶æ›´æ–°çŠ¶æ€ï¼‰ï¼š
```text
â•­â”€ ğŸ§­ Cycle-Master AI â”€â”€ [Status: Phase X] â”€â•®
â”‚ ğŸ¯ Target: [å½“å‰åˆ†æçš„è¡Œä¸š]                 â”‚
â”‚ ğŸ“Š Cycle: äº§ä¸š [é˜¶æ®µ] | æ”¿ç­– [é˜¶æ®µ]        â”‚
â”‚ ğŸ’¡ Type: [åˆ†ç±»ï¼šå¦‚ æŠ€æœ¯çªç ´å‹]              â”‚
â”‚ ğŸ‘‰ NEXT: [æç¤ºç”¨æˆ·ä¸‹ä¸€æ­¥éª¤æˆ–éœ€è¦æä¾›çš„æ•°æ®]   â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
```
"""

# ==========================================
# ä¾§è¾¹æ ï¼šç”¨æˆ·çŠ¶æ€ä¸ä¸Šä¸‹æ–‡
# ==========================================

with st.sidebar:
    st.header("ğŸ‘¤ æ‚¨çš„èƒŒæ™¯è®¾å®š")
    # é»˜è®¤å€¼å·²å¾®è°ƒä¸ºæ›´è´´è¿‘ç§‘ç ”ä¸æ•™ç ”ç®¡ç†çš„åœºæ™¯
    user_role = st.text_input("å½“å‰èŒä¸š/è§’è‰²", "ä¾‹å¦‚ï¼šé«˜æ ¡ç§‘ç ”äººå‘˜ / è®¡ç®—æœºåº”ç”¨é«˜çº§å®éªŒå¸ˆ")
    user_goal = st.selectbox("æ ¸å¿ƒè¯‰æ±‚", [
        "èŒä¸šè§„åˆ’ä¸è½¬å‹è¯„ä¼°",
        "äº§æ•™èåˆ/èŒä¸šæ•™è‚²èµ›é“ç ”ç©¶",
        "é“¶å‘ç»æµ/ç¤¾åŒºæ•™è‚²æ–¹å‘æ¢ç´¢",
        "æ’°å†™è¡Œä¸šè°ƒç ”æŠ¥å‘Š"
    ])
    st.markdown("---")
    
    if st.button("ğŸ”„ æ¸…ç©ºå¯¹è¯è®°å¿†"):
        st.session_state.messages = []
        st.rerun()


# ==========================================
# å¯¹è¯çŠ¶æ€ç®¡ç† (Session State)
# ==========================================

if "messages" not in st.session_state or len(st.session_state.messages) == 0:
    st.session_state.messages = [{"role": "system", "content": SYSTEM_PROMPT}]
    
    welcome_msg = "æ‚¨å¥½ï¼æˆ‘æ˜¯ Cycle-Master AIï¼Œç³»ç»Ÿå·²æˆåŠŸè½½å…¥**é©¬æ±Ÿåšäº§ä¸šä¸æ”¿ç­–äºŒå…ƒå‘¨æœŸæ¡†æ¶**ã€‚"
    if 'target_industry' in st.session_state and st.session_state['target_industry']:
        welcome_msg += f"\n\nç›‘æµ‹åˆ°æ‚¨ä»ã€å‘¨æœŸå®éªŒå®¤ã€‘å¸¦æ¥äº†é‡ç‚¹å…³æ³¨è¡Œä¸šï¼š**{st.session_state['target_industry']}**ã€‚æ‚¨å¸Œæœ›æˆ‘ä»¬ç°åœ¨å¼€å§‹å¯¹è¯¥é¢†åŸŸè¿›è¡Œæ·±åº¦çš„å‘¨æœŸæ¨æ¼”å—ï¼Ÿ"
    else:
        welcome_msg += "\n\nè¯·é—®æ‚¨ç›®å‰æ­£åœ¨å…³æ³¨å“ªä¸ªè¡Œä¸šï¼Ÿæˆ–è€…æ‚¨æƒ³è¯„ä¼°å“ªä¸ªå…·ä½“çš„ç ”ç©¶ä¸è§„åˆ’æ–¹å‘ï¼Ÿ"
        
    st.session_state.messages.append({"role": "assistant", "content": welcome_msg})


# ==========================================
# æ¸²æŸ“å†å²å¯¹è¯
# ==========================================

for message in st.session_state.messages:
    if message["role"] != "system":
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

# ==========================================
# å¤„ç†ç”¨æˆ·è¾“å…¥ä¸å¤§æ¨¡å‹ API è°ƒç”¨
# ==========================================

if prompt := st.chat_input("è¯·è¾“å…¥æ‚¨æƒ³åˆ†æçš„è¡Œä¸šã€èµ›é“æˆ–å½“å‰é¢ä¸´çš„è§„åˆ’é—®é¢˜..."):
    contextual_prompt = prompt
    # ä»…åœ¨åˆå§‹æé—®æ—¶éšå¼æ³¨å…¥ä¾§è¾¹æ èƒŒæ™¯
    if len(st.session_state.messages) <= 2:
        contextual_prompt = f"[èƒŒæ™¯æ³¨å…¥ -> ç”¨æˆ·è§’è‰²ï¼š{user_role}ï¼Œæ ¸å¿ƒè¯‰æ±‚ï¼š{user_goal}] \n\nç”¨æˆ·è¾“å…¥ï¼š{prompt}"
    
    st.session_state.messages.append({"role": "user", "content": contextual_prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.chat_message("assistant"):
        message_placeholder = st.empty()
        full_response = ""
        
        try:
            stream = client.chat.completions.create(
                model="deepseek-chat", 
                messages=st.session_state.messages,
                stream=True,
                temperature=0.6 
            )
            
            for chunk in stream:
                if chunk.choices[0].delta.content is not None:
                    full_response += chunk.choices[0].delta.content
                    message_placeholder.markdown(full_response + "â–Œ")
            
            message_placeholder.markdown(full_response)
            
        except Exception as e:
            st.error(f"DeepSeek API è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– API Key: {str(e)}")
            st.stop()
            
    st.session_state.messages.append({"role": "assistant", "content": full_response})
